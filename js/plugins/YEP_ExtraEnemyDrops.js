var Imported=Imported||{};Imported.YEP_ExtraEnemyDrops=true;var Yanfly=Yanfly||{};Yanfly.EED=Yanfly.EED||{};Yanfly.EED.version=1.09;Yanfly.Parameters=PluginManager.parameters("YEP_ExtraEnemyDrops");Yanfly.Param=Yanfly.Param||{};Yanfly.Param.Variables=String(Yanfly.Parameters["Variables"]);Yanfly.EED.DataManager_isDatabaseLoaded=DataManager.isDatabaseLoaded;DataManager.isDatabaseLoaded=function(){if(!Yanfly.EED.DataManager_isDatabaseLoaded.call(this))return false;if(!Yanfly._loaded_YEP_ExtraEnemyDrops){this.processEEDNotetagsI($dataItems);this.processEEDNotetagsW($dataWeapons);this.processEEDNotetagsA($dataArmors);this.processEEDNotetagsS($dataSkills);this.processEEDNotetagsT($dataStates);this.processEEDNotetagsSys($dataSystem);this.processEEDNotetags1($dataEnemies);Yanfly._loaded_YEP_ExtraEnemyDrops=true}return true};DataManager.processEEDNotetagsI=function(group){if(Yanfly.ItemIdRef)return;Yanfly.ItemIdRef={};for(var n=1;n<group.length;n++){var obj=group[n];if(obj.name.length<=0)continue;Yanfly.ItemIdRef[obj.name.toUpperCase()]=n}};DataManager.processEEDNotetagsW=function(group){if(Yanfly.WeaponIdRef)return;Yanfly.WeaponIdRef={};for(var n=1;n<group.length;n++){var obj=group[n];if(obj.name.length<=0)continue;Yanfly.WeaponIdRef[obj.name.toUpperCase()]=n}};DataManager.processEEDNotetagsA=function(group){if(Yanfly.ArmorIdRef)return;Yanfly.ArmorIdRef={};for(var n=1;n<group.length;n++){var obj=group[n];if(obj.name.length<=0)continue;Yanfly.ArmorIdRef[obj.name.toUpperCase()]=n}};DataManager.processEEDNotetagsS=function(group){if(Yanfly.SkillIdRef)return;Yanfly.SkillIdRef={};for(var n=1;n<group.length;n++){var obj=group[n];if(obj.name.length<=0)continue;Yanfly.SkillIdRef[obj.name.toUpperCase()]=n}};DataManager.processEEDNotetagsT=function(group){if(Yanfly.StateIdRef)return;Yanfly.StateIdRef={};for(var n=1;n<group.length;n++){var obj=group[n];if(obj.name.length<=0)continue;Yanfly.StateIdRef[obj.name.toUpperCase()]=n}};DataManager.processEEDNotetagsSys=function(group){Yanfly.STypeIdRef={};for(var i=1;i<group.skillTypes.length;++i){var name=group.skillTypes[i].toUpperCase();name=name.replace(/\\I\[(\d+)\]/gi,"");Yanfly.STypeIdRef[name]=i}Yanfly.ElementIdRef={};for(var i=1;i<group.elements.length;++i){var name=group.elements[i].toUpperCase();name=name.replace(/\\I\[(\d+)\]/gi,"");Yanfly.ElementIdRef[name]=i}};DataManager.processEEDNotetags1=function(group){var noteD1=/<(?:ITEM|DROP ITEM)[ ](\d+):[ ](\d+)([%％])>/i;var noteD2=/<(?:WEAPON|DROP WEAPON)[ ](\d+):[ ](\d+)([%％])>/i;var noteD3=/<(?:ARMOR|DROP armor)[ ](\d+):[ ](\d+)([%％])>/i;for(var n=1;n<group.length;n++){var obj=group[n];if(obj.dropsMade)continue;var notedata=obj.note.split(/[\r\n]+/);obj.dropsMade=true;obj.conditionalDropItems=[];var conditionalLines=[];var evalMode="none";for(var i=0;i<notedata.length;i++){var line=notedata[i];if(line.match(noteD1)){var id=parseInt(RegExp.$1);var rate=parseFloat(RegExp.$2)*.01;this.createEnemyDrop(obj,id,rate,1)}else if(line.match(noteD2)){var id=parseInt(RegExp.$1);var rate=parseFloat(RegExp.$2)*.01;this.createEnemyDrop(obj,id,rate,2)}else if(line.match(noteD3)){var id=parseInt(RegExp.$1);var rate=parseFloat(RegExp.$2)*.01;this.createEnemyDrop(obj,id,rate,3)}else if(line.match(/<DROP[ ](.*):[ ](\d+)([%％])>/i)){var name=String(RegExp.$1).toUpperCase();var rate=parseFloat(RegExp.$2)*.01;if(Yanfly.ItemIdRef[name]){var id=Yanfly.ItemIdRef[name];var kind=1}else if(Yanfly.WeaponIdRef[name]){var id=Yanfly.WeaponIdRef[name];var kind=2}else if(Yanfly.ArmorIdRef[name]){var id=Yanfly.ArmorIdRef[name];var kind=3}else{continue}this.createEnemyDrop(obj,id,rate,kind)}else if(line.match(/<(?:ENEMY DROP|ENEMY DROPS)>/i)){var evalMode="drops"}else if(line.match(/<\/(?:ENEMY DROP|ENEMY DROPS)>/i)){var evalMode="none"}else if(evalMode==="drops"){if(line.match(/ITEM[ ](\d+):[ ](\d+)([%％])/i)){var id=parseInt(RegExp.$1);var rate=parseFloat(RegExp.$2)*.01;this.createEnemyDrop(obj,id,rate,1)}else if(line.match(/WEAPON[ ](\d+):[ ](\d+)([%％])/i)){var id=parseInt(RegExp.$1);var rate=parseFloat(RegExp.$2)*.01;this.createEnemyDrop(obj,id,rate,2)}else if(line.match(/ARMOR[ ](\d+):[ ](\d+)([%％])/i)){var id=parseInt(RegExp.$1);var rate=parseFloat(RegExp.$2)*.01;this.createEnemyDrop(obj,id,rate,3)}else if(line.match(/(.*):[ ](\d+)([%％])/i)){var name=String(RegExp.$1).toUpperCase();var rate=parseFloat(RegExp.$2)*.01;if(Yanfly.ItemIdRef[name]){var id=Yanfly.ItemIdRef[name];var kind=1}else if(Yanfly.WeaponIdRef[name]){var id=Yanfly.WeaponIdRef[name];var kind=2}else if(Yanfly.ArmorIdRef[name]){var id=Yanfly.ArmorIdRef[name];var kind=3}else{continue}this.createEnemyDrop(obj,id,rate,kind)}}else if(line.match(/<CONDITIONAL[ ](.*)[ ]DROP>/i)){var evalMode="conditionalDrop";conditionalLines=[]}else if(line.match(/<\/CONDITIONAL[ ](.*)[ ]DROP>/i)){var evalMode="none";var name=String(RegExp.$1).toUpperCase();if(name.match(/ITEM[ ](\d+)/i)){var item=$dataItems[parseInt(RegExp.$1)]}else if(name.match(/WEAPON[ ](\d+)/i)){var item=$dataWeapons[parseInt(RegExp.$1)]}else if(name.match(/ARMOR[ ](\d+)/i)){var item=$dataArmors[parseInt(RegExp.$1)]}else if(Yanfly.ItemIdRef[name]){var id=Yanfly.ItemIdRef[name];var item=$dataItems[id]}else if(Yanfly.WeaponIdRef[name]){var id=Yanfly.WeaponIdRef[name];var item=$dataWeapons[id]}else if(Yanfly.ArmorIdRef[name]){var id=Yanfly.ArmorIdRef[name];var item=$dataArmors[id]}else{continue}if(!item)continue;var arr=[item,conditionalLines];obj.conditionalDropItems.push(arr);conditionalLines=[]}else if(evalMode==="conditionalDrop"){conditionalLines.push(line)}}}};DataManager.createEnemyDrop=function(obj,dataId,rate,kind){var dropItem={dataId:dataId,denominator:1/rate,kind:kind};obj.dropItems.push(dropItem)};Yanfly.EED.Game_BattlerBase_addNewState=Game_BattlerBase.prototype.addNewState;Game_BattlerBase.prototype.addNewState=function(stateId){Yanfly.EED.Game_BattlerBase_addNewState.call(this,stateId);if(this.isEnemy())this.markStruckState(stateId);if(stateId===this.deathStateId()&&this.isEnemy()){this.markDeathTurn()}};Yanfly.EED.Game_Enemy_makeDropItems=Game_Enemy.prototype.makeDropItems;Game_Enemy.prototype.makeDropItems=function(){var drops=Yanfly.EED.Game_Enemy_makeDropItems.call(this);drops=drops.concat(this.makeConditionalDropItems());return drops};Game_Enemy.prototype.makeConditionalDropItems=function(){var drops=DropManager.setup(this);return drops};Game_Enemy.prototype.markDeathTurn=function(){if(this._selfTurnCount!==undefined){this._deathTurn=this._selfTurnCount}else{this._deathTurn=$gameTroop.turnCount()}};Game_Enemy.prototype.markStruckState=function(id){this.createTimesStruck();this._struckStates[id]=this._struckStates[id]||0;this._struckStates[id]=this._struckStates[id]+1};Game_Enemy.prototype.deathTurn=function(){return this._deathTurn||0};Game_Enemy.prototype.createTimesStruck=function(){if(this._struckSkills===undefined)this._struckSkills={};if(this._struckSType===undefined)this._struckSType={};if(this._struckItems===undefined)this._struckItems={};if(this._struckStates===undefined)this._struckStates={};if(this._struckElements===undefined)this._struckElements={};if(this._lastStruckId===undefined)this._lastStruckId=0;if(this._lastStruckSkill===undefined)this._lastStruckSkill=false;if(this._lastStruckActor===undefined)this._lastStruckActor=null};Game_Enemy.prototype.lastStruckAction=function(){if(this._lastStruckId===undefined)this.createTimesStruck();if(this._lastStruckSkill===undefined)this.createTimesStruck();if(this._lastStruckSkill){return $dataSkills[this._lastStruckId]}else{return $dataItems[this._lastStruckId]}};Game_Enemy.prototype.markStruckActions=function(item,subject,action){if(!item)return;this.createTimesStruck();this._lastStruckId=item.id;this._lastStruckSkill=DataManager.isSkill(item);this.markLastStruckActor(subject);if(DataManager.isSkill(item)){this._struckSkills[item.id]=this._struckSkills[item.id]||0;this._struckSkills[item.id]=this._struckSkills[item.id]+1;this._struckSType[item.stypeId]=this._struckSType[item.stypeId]||0;this._struckSType[item.stypeId]=this._struckSType[item.stypeId]+1}if(DataManager.isItem(item)){this._struckItems[item.id]=this._struckItems[item.id]||0;this._struckItems[item.id]=this._struckItems[item.id]+1}this.markStruckElements(item,subject,action)};Game_Enemy.prototype.killer=function(){if(this._lastStruckActor>0){return $gameActors.actor(this._lastStruckActor)}else{return this}};Game_Enemy.prototype.markLastStruckActor=function(subject){if(subject&&subject.isActor())this._lastStruckActor=subject.actor().id};Game_Enemy.prototype.markStruckElements=function(item,subject,action){if(Imported.YEP_ElementCore&&action){var elements=action.getItemElements()}else if(item.damage.elementId<0){var elements=subject.attackElements()}else{var elements=[item.damage.elementId]}var length=elements.length;for(var i=0;i<length;++i){var eleId=elements[i];if(eleId<=0)continue;this._struckElements[eleId]=this._struckElements[eleId]||0;this._struckElements[eleId]=this._struckElements[eleId]+1}};Game_Enemy.prototype.timesStruckSkill=function(id){this.createTimesStruck();return this._struckSkills[id]||0};Game_Enemy.prototype.timesStruckItem=function(id){this.createTimesStruck();return this._struckItems[id]||0};Game_Enemy.prototype.timesStruckSType=function(id){this.createTimesStruck();return this._struckSType[id]||0};Game_Enemy.prototype.timesStruckState=function(id){this.createTimesStruck();return this._struckStates[id]||0};Game_Enemy.prototype.timesStruckElement=function(id){this.createTimesStruck();return this._struckElements[id]||0};Yanfly.EED.Game_Action_applyItemUserEffect=Game_Action.prototype.applyItemUserEffect;Game_Action.prototype.applyItemUserEffect=function(target){Yanfly.EED.Game_Action_applyItemUserEffect.call(this,target);if(target&&target.isEnemy()){target.markStruckActions(this.item(),this.subject(),this)}};function DropManager(){throw new Error("This is a static class")}DropManager.setup=function(enemy){this._enemy=enemy;this._data=this._enemy.enemy().conditionalDropItems;this._drops=[];this.makeConditionalDropItems();return this._drops};DropManager.makeConditionalDropItems=function(){var length=this._data.length;if(length<=0)return;for(var i=0;i<length;++i){var data=this._data[i];var item=data[0];var conditions=data[1];if(Math.random()<this.getConditionalRate(conditions)){this._drops.push(item)}}};DropManager.getConditionalRate=function(conditions){var rate=0;var length=conditions.length;for(var i=0;i<length;++i){var condition=conditions[i];if(condition.match(/(.*):[ ]([\+\-]\d+)([%％])/i)){var line=String(RegExp.$1);var value=parseFloat(RegExp.$2)*.01;if(this.meetsLineCondition(line))rate+=value}}return rate};DropManager.meetsLineCondition=function(line){if(line.match(/EVAL[ ](.*)/i)){var line=String(RegExp.$1);return this.conditionEval(line)}if(line.match(/ALIVE MEMBERS[ ](.*)/i)){var line=String(RegExp.$1);return this.conditionAliveMembers(line)}if(line.toUpperCase()==="ALWAYS"){return this.conditionAlways()}if(line.match(/(.*)[ ]COUNT[ ](.*)/i)){var line1=String(RegExp.$1);var line2=String(RegExp.$2);return this.conditionCount(line1,line2)}if(line.match(/DEAD MEMBERS[ ](.*)/i)){var line=String(RegExp.$1);return this.conditionDeadMembers(line)}if(line.match(/DEATH TURN[ ](.*)/i)){var line=String(RegExp.$1);return this.conditionDeathTurn(line)}if(line.match(/ENEMY LEVEL[ ](.*)/i)){var line=String(RegExp.$1);return this.conditionEnemyLevel(line)}if(line.match(/LAST STRIKE[ ](.*)/i)){var line=String(RegExp.$1);return this.conditionLastStrike(line)}if(line.match(/PARTY MEMBERS[ ](.*)/i)){var line=String(RegExp.$1);return this.conditionPartyMembers(line)}if(line.match(/RANDOM[ ](\d+)([%％])/i)){var rate=parseFloat(RegExp.$1)*.01;return this.conditionRandom(rate)}if(line.match(/TIMES[ ](.*)[ ]STRUCK[ ](.*)/i)){var line1=String(RegExp.$1);var line2=String(RegExp.$2);return this.conditionTimesStruck(line1,line2)}if(line.match(/SWITCH[ ](\d+)[ ](.*)/i)){var switchId=parseInt(RegExp.$1);var switchCase=String(RegExp.$2).toUpperCase();return this.conditionSwitch(switchId,switchCase)}if(line.match(/TURN[ ](.*)/i)){var line=String(RegExp.$1);return this.conditionTurn(line)}if(line.match(/VARIABLE[ ](\d+)[ ](.*)/i)){var varId=parseInt(RegExp.$1);var varLine=String(RegExp.$2).toUpperCase();return this.conditionVariable(varId,varLine)}return false};DropManager.conditionAliveMembers=function(line){var user=this._enemy;var enemy=this._enemy;var a=this._enemy;var s=$gameSwitches._data;var v=$gameVariables._data;var code="$gameParty.aliveMembers().length "+line;try{return eval(code)}catch(e){Yanfly.Util.displayError(e,code,"ENEMY DROP ALIVE CONDITION ERROR");return false}};DropManager.conditionAlways=function(){return true};DropManager.conditionCount=function(line1,line2){var item=null;if(line1.match(/ITEM[ ](\d+)/i)){item=$dataItems[parseInt(RegExp.$1)]}else if(line1.match(/WEAPON[ ](\d+)/i)){item=$dataWeapons[parseInt(RegExp.$1)]}else if(line1.match(/ARMOR[ ](\d+)/i)){item=$dataArmors[parseInt(RegExp.$1)]}else if(Yanfly.ItemIdRef[line1.toUpperCase()]){item=$dataItems[Yanfly.ItemIdRef[line1.toUpperCase()]]}else if(Yanfly.WeaponIdRef[line1.toUpperCase()]){item=$dataWeapons[Yanfly.WeaponIdRef[line1.toUpperCase()]]}else if(Yanfly.ArmorIdRef[line1.toUpperCase()]){item=$dataArmors[Yanfly.ArmorIdRef[line1.toUpperCase()]]}if(!item)return false;if(Imported.YEP_ItemCore&&DataManager.isIndependent(item)){var quantity=$gameParty.numIndependentItems(item)}else{var quantity=$gameParty.numItems(item)}var user=this._enemy;var enemy=this._enemy;var a=this._enemy;var s=$gameSwitches._data;var v=$gameVariables._data;var code="quantity "+line2;try{return eval(code)}catch(e){Yanfly.Util.displayError(e,code,"ENEMY DROP COUNT ERROR");return false}};DropManager.conditionDeadMembers=function(line){var user=this._enemy;var enemy=this._enemy;var a=this._enemy;var s=$gameSwitches._data;var v=$gameVariables._data;var code="$gameParty.deadMembers().length "+line;try{return eval(code)}catch(e){Yanfly.Util.displayError(e,code,"ENEMY DROP DEAD MEMBERS ERROR");return false}};DropManager.conditionDeathTurn=function(line){var user=this._enemy;var enemy=this._enemy;var a=this._enemy;var s=$gameSwitches._data;var v=$gameVariables._data;var code="user.deathTurn() "+line;try{return eval(code)}catch(e){Yanfly.Util.displayError(e,code,"ENEMY DROP DEATH TURN ERROR");return false}};DropManager.conditionEnemyLevel=function(line){if(!Imported.YEP_EnemyLevels)return false;var user=this._enemy;var enemy=this._enemy;var a=this._enemy;var s=$gameSwitches._data;var v=$gameVariables._data;var code="enemy.level "+line;try{return eval(code)}catch(e){Yanfly.Util.displayError(e,code,"ENEMY DROP ENEMY LEVEL ERROR");return false}};DropManager.conditionLastStrike=function(line){if(line.match(/SKILL[ ](\d+)/i)){var id=parseInt(RegExp.$1);return this._enemy.lastStruckAction()===$dataSkills[id]}else if(line.match(/ITEM[ ](\d+)/i)){var id=parseInt(RegExp.$1);return this._enemy.lastStruckAction()===$dataItems[id]}else if(Yanfly.SkillIdRef[line.toUpperCase()]){var id=Yanfly.SkillIdRef[line.toUpperCase()];return this._enemy.lastStruckAction()===$dataSkills[id]}else if(Yanfly.ItemIdRef[line.toUpperCase()]){var id=Yanfly.ItemIdRef[line.toUpperCase()];return this._enemy.lastStruckAction()===$dataItems[id]}return false};DropManager.conditionPartyMembers=function(line){var user=this._enemy;var enemy=this._enemy;var a=this._enemy;var s=$gameSwitches._data;var v=$gameVariables._data;var code="$gameParty.battleMembers().length "+line;try{return eval(code)}catch(e){Yanfly.Util.displayError(e,code,"ENEMY DROP PARTY SIZE ERROR");return false}};DropManager.conditionRandom=function(rate){return Math.random()<rate};DropManager.conditionSwitch=function(switchId,switchCase){var condition=false;if(["ON","TRUE"].contains(switchCase))condition=true;return $gameSwitches.value(switchId)===condition};DropManager.conditionTimesStruck=function(line1,line2){var times=this.getTimesStruck(line1);var user=this._enemy;var enemy=this._enemy;var a=this._enemy;var s=$gameSwitches._data;var v=$gameVariables._data;var code="times "+line2;try{return eval(code)}catch(e){Yanfly.Util.displayError(e,code,"ENEMY DROP TIMES STRUCK ERROR");return false}};DropManager.getTimesStruck=function(line){var times=0;if(line.match(/SKILL[ ](\d+)/i)){var id=parseInt(RegExp.$1);times=this._enemy.timesStruckSkill(id)}else if(line.match(/SKILL[ ](.*)/i)){var name=String(RegExp.$1).toUpperCase();if(Yanfly.SkillIdRef[name]){var id=Yanfly.SkillIdRef[name];times=this._enemy.timesStruckSkill(id)}}else if(line.match(/ITEM[ ](\d+)/i)){var id=parseInt(RegExp.$1);times=this._enemy.timesStruckItem(id)}else if(line.match(/ITEM[ ](.*)/i)){var name=String(RegExp.$1).toUpperCase();if(Yanfly.ItemIdRef[name]){var id=Yanfly.ItemIdRef[name];times=this._enemy.timesStruckItem(id)}}else if(line.match(/STYPE[ ](\d+)/i)){var id=parseInt(RegExp.$1);times=this._enemy.timesStruckSType(id)}else if(line.match(/STYPE[ ](.*)/i)){var name=String(RegExp.$1).toUpperCase();if(Yanfly.STypeIdRef[name]){var id=Yanfly.STypeIdRef[name];times=this._enemy.timesStruckSType(id)}}else if(line.match(/STATE[ ](\d+)/i)){var id=parseInt(RegExp.$1);times=this._enemy.timesStruckState(id)}else if(line.match(/STATE[ ](.*)/i)){var name=String(RegExp.$1).toUpperCase();if(Yanfly.StateIdRef[name]){var id=Yanfly.StateIdRef[name];times=this._enemy.timesStruckState(id)}}else if(line.match(/ELEMENT[ ](\d+)/i)){var id=parseInt(RegExp.$1);times=this._enemy.timesStruckElement(id)}else if(line.match(/ELEMENT[ ](.*)/i)){var name=String(RegExp.$1).toUpperCase();if(Yanfly.ElementIdRef[name]){var id=Yanfly.ElementIdRef[name];times=this._enemy.timesStruckElement(id)}}return times};DropManager.conditionTurn=function(line){var user=this._enemy;var enemy=this._enemy;var a=this._enemy;var s=$gameSwitches._data;var v=$gameVariables._data;var code="$gameTroop.turnCount() "+line;try{return eval(code)}catch(e){Yanfly.Util.displayError(e,code,"ENEMY DROP TURN ERROR");return false}};DropManager.conditionVariable=function(varId,varLine){var value=false;var code="$gameVariables.value(varId) "+varLine;try{return eval(code)}catch(e){Yanfly.Util.displayError(e,code,"ENEMY DROP VARIABLE ERROR");return false}};DropManager.conditionEval=function(code){var user=this._enemy;var enemy=this._enemy;var a=this._enemy;var s=$gameSwitches._data;var v=$gameVariables._data;try{return eval(code)}catch(e){Yanfly.Util.displayError(e,code,"ENEMY DROP EVAL ERROR");return false}};Yanfly.Util=Yanfly.Util||{};Yanfly.Util.displayError=function(e,code,message){console.log(message);console.log(code||"NON-EXISTENT");console.error(e);if(Utils.RPGMAKER_VERSION&&Utils.RPGMAKER_VERSION>="1.6.0")return;if(Utils.isNwjs()&&Utils.isOptionValid("test")){if(!require("nw.gui").Window.get().isDevToolsOpen()){require("nw.gui").Window.get().showDevTools()}}};